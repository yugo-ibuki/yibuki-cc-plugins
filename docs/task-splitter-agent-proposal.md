# Task Splitter Agent 設計概要

## 概要

タスクを分析して並列実行可能なサブタスクに分割し、各サブタスクに関連ファイルを紐付けるsubagent。

## 背景・課題

現状のフロー:
```
タスク記述 → project-onboarding agent → 関連ファイル群 → メインで照合 → 実装
```

課題:
- 大きなタスクは手動で分割が必要
- ファイル群が多いと、どのファイルがどのサブタスクに対応するか不明確
- 並列実行の判断もメインで行う必要がある

## 提案するフロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. ユーザーがタスクを記述                                         │
│    「ログイン機能にOAuth対応を追加。Google/GitHubに対応。          │
│     既存のメール認証は維持。テストも追加する」                      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. project-onboarding agent（既存）                              │
│    → 関連ファイル群を検索                                         │
│    結果: src/auth/*, src/hooks/useAuth.ts, tests/auth/* など     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. task-splitter agent（新規）                                   │
│                                                                 │
│    入力:                                                         │
│    - タスク詳細                                                   │
│    - 関連ファイル群（from project-onboarding）                    │
│                                                                 │
│    処理:                                                         │
│    - タスクをサブタスクに分解                                      │
│    - 依存関係を分析（並列可能 / 直列必須）                          │
│    - 各サブタスクに関連ファイルを紐付け                             │
│                                                                 │
│    出力:                                                         │
│    サブタスクリスト（ファイル紐付け済み）                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. メインコンテキスト                                             │
│                                                                 │
│    分割結果を受け取り:                                            │
│    - 並列実行可能なタスクは同時にagent起動                         │
│    - 依存関係があるタスクは順次実行                                 │
└─────────────────────────────────────────────────────────────────┘
```

## task-splitter agent の出力イメージ

```markdown
# タスク分割結果

## 元タスク
ログイン機能にOAuth対応を追加。Google/GitHubに対応。既存のメール認証は維持。テストも追加。

## サブタスク一覧

### Phase 1（並列実行可能）

| ID | タスク | 関連ファイル | 見積もり |
|----|--------|-------------|---------|
| 1-1 | OAuth基盤の実装 | `src/auth/oauth.ts`(新規), `src/auth/types.ts` | 中 |
| 1-2 | Google OAuth実装 | `src/auth/providers/google.ts`(新規) | 小 |
| 1-3 | GitHub OAuth実装 | `src/auth/providers/github.ts`(新規) | 小 |

### Phase 2（Phase 1完了後）

| ID | タスク | 関連ファイル | 依存 |
|----|--------|-------------|------|
| 2-1 | useAuth hook拡張 | `src/hooks/useAuth.ts` | 1-1 |
| 2-2 | ログインUI更新 | `src/components/LoginForm.tsx` | 1-1 |

### Phase 3（Phase 2完了後）

| ID | タスク | 関連ファイル | 依存 |
|----|--------|-------------|------|
| 3-1 | OAuth テスト | `tests/auth/oauth.test.ts`(新規) | 2-1, 2-2 |
| 3-2 | 既存テスト更新 | `tests/auth/login.test.ts` | 2-1 |

## 依存関係図

```
Phase 1 (並列)          Phase 2 (並列)        Phase 3 (並列)
┌─────────────┐
│ 1-1 OAuth基盤 │──────┬──→ 2-1 useAuth ──────→ 3-1 OAuth テスト
└─────────────┘      │
┌─────────────┐      └──→ 2-2 LoginUI ───────→ 3-2 既存テスト更新
│ 1-2 Google   │
└─────────────┘
┌─────────────┐
│ 1-3 GitHub   │
└─────────────┘
```

## 実行計画

```bash
# Phase 1: 3つのagentを並列実行
Task(1-1), Task(1-2), Task(1-3) → 並列

# Phase 2: Phase 1完了後、2つのagentを並列実行
Task(2-1), Task(2-2) → 並列

# Phase 3: Phase 2完了後、2つのagentを並列実行
Task(3-1), Task(3-2) → 並列
```
```

## 技術的な実現方法

### agent定義

```yaml
name: task-splitter
description: タスクをサブタスクに分割し、関連ファイルを紐付け、並列実行計画を作成する
allowed-tools:
  - Read
  - Glob
  - Grep
```

### 入力パラメータ

```
prompt: |
  以下のタスクを分割してください。

  ## タスク詳細
  {user_task_description}

  ## 関連ファイル群（project-onboarding agentの結果）
  {related_files}

  ## 出力形式
  - サブタスクをPhaseに分けて出力
  - 各サブタスクに関連ファイルを紐付け
  - 依存関係を明示
  - 並列実行可能なものをグループ化
```

### メインでの利用例

```python
# 1. 関連ファイルを取得
files = Task(
    subagent_type="project-onboarding",
    prompt="ログイン OAuth に関連するファイルを検索"
)

# 2. タスクを分割
plan = Task(
    subagent_type="task-splitter",
    prompt=f"""
    タスク: ログイン機能にOAuth対応を追加
    関連ファイル: {files}
    """
)

# 3. Phase 1を並列実行
Task(prompt=plan.phase1.task1, ...)  # 並列
Task(prompt=plan.phase1.task2, ...)  # 並列
Task(prompt=plan.phase1.task3, ...)  # 並列

# 4. Phase 2を並列実行（Phase 1完了後）
...
```

## project-onboarding agent との連携

```
┌─────────────────────┐     ┌─────────────────────┐
│ project-onboarding  │────→│   task-splitter     │
│                     │     │                     │
│ - ファイル検索       │     │ - タスク分解         │
│ - import解析        │     │ - 依存関係分析       │
│ - monorepo検出      │     │ - ファイル紐付け     │
└─────────────────────┘     │ - 並列計画作成       │
                            └─────────────────────┘
```

## 想定されるユースケース

1. **大規模機能追加**: 複数コンポーネントにまたがる変更を分割
2. **リファクタリング**: 影響範囲を分析して安全に分割
3. **バグ修正 + テスト追加**: 修正とテストを並列化
4. **monorepoでの変更**: パッケージごとに分割して並列実行

## 次のステップ

1. task-splitter agent の AGENT.md を作成
2. /split-task コマンドを作成
3. project-onboarding との連携をテスト
4. 並列実行のワークフロー検証

## 備考

- 分割の粒度はユーザーが調整可能にする（「細かく分割」「大まかに分割」）
- 依存関係の自動検出は完璧ではないので、ユーザーが修正可能に
- 見積もり（小/中/大）は目安として出力
