---
name: pr-review-comment
description: PRの変更点を分析してレビューコメントを作成するスキル。GitHub PRのdiffを解析し、コード品質・バグ・セキュリティ・パフォーマンス等の観点から適切なレビューコメントを生成する。「PRをレビュー」「コードレビュー」「変更点を確認」などのリクエストで自動呼び出し。
version: "1.0.0"
allowed-tools:
  - Read
  - Glob
  - Grep
  - Bash(git diff:*)
  - Bash(git log:*)
  - Bash(git show:*)
  - Bash(gh pr:*)
  - Bash(gh api:*)
user-invocable: true
---

# pr-review-comment スキル

PRの変更点を分析し、適切なレビューコメントを作成するスキル。

## 目的

- PRの変更内容を包括的に分析
- コードレビューの観点から問題点・改善案・良い点を特定
- 建設的で実用的なレビューコメントを生成

## レビュー観点

以下の観点から変更を分析する：

### 1. コード品質
- 可読性（変数名、関数名、コメント）
- 複雑度（ネストの深さ、関数の長さ）
- DRY原則（重複コードの有無）
- 単一責任原則

### 2. バグ・エラー
- 境界値・エッジケース
- null/undefined のハンドリング
- 例外処理
- 型の不整合

### 3. セキュリティ
- インジェクション脆弱性（SQL、XSS、コマンド）
- 認証・認可のチェック漏れ
- 機密情報の露出
- 入力値の検証

### 4. パフォーマンス
- 不要なループ・計算
- N+1 クエリ
- メモリリーク
- 非効率なアルゴリズム

### 5. テスト
- テストカバレッジ
- エッジケースのテスト
- モックの適切性

### 6. ポジティブフィードバック
- 良い設計・実装
- 改善された部分
- 学べるテクニック

## ワークフロー

### 1. 変更内容の取得

```bash
# ローカルの場合
git diff main...HEAD

# GitHub PRの場合
gh pr diff <PR番号>
```

### 2. 変更ファイルの分析

各ファイルについて：
1. ファイルの役割を把握
2. 追加・削除・変更された行を確認
3. 変更の意図を理解

### 3. コンテキストの確認

必要に応じて：
- 関連ファイルを読み込む
- テストファイルを確認
- 設定ファイルを確認

### 4. レビューコメント生成

## 出力フォーマット

### 概要セクション

```markdown
## PR概要

**対象:** PR #123 または ローカル変更
**変更ファイル数:** 5
**追加行数:** +120
**削除行数:** -45

### 変更の要約
- 認証機能にOAuth2サポートを追加
- 既存のセッション管理を改善
- 関連テストを追加
```

### レビューコメントセクション

```markdown
## レビューコメント

### 要確認 (Must Fix)

#### 1. セキュリティ: SQLインジェクションの可能性
📍 `src/db/users.ts:45`

```diff
- const result = await db.query(`SELECT * FROM users WHERE id = ${userId}`)
+ const result = await db.query('SELECT * FROM users WHERE id = $1', [userId])
```

**理由:** ユーザー入力を直接クエリに埋め込むとSQLインジェクションの脆弱性になります。
**提案:** プリペアドステートメントを使用してください。

---

### 改善提案 (Suggestion)

#### 2. 可読性: 関数の分割
📍 `src/auth/oauth.ts:78-120`

この関数は42行あり、複数の責務を持っています。
以下の3つに分割することを提案します：
- `validateOAuthConfig()`
- `exchangeAuthCode()`
- `createUserSession()`

---

### 良い点 (Nice!)

#### 3. テストカバレッジ
📍 `src/auth/__tests__/oauth.test.ts`

エッジケースを含む包括的なテストが追加されています。
特に認証失敗パターンのテストが充実しています。
```

## 使用方法

### ローカル変更のレビュー

```
PRの変更点をレビューして
```

→ `git diff main...HEAD` を使用してローカルの変更を分析

### GitHub PRのレビュー

```
PR #123 をレビューして
```

または

```
https://github.com/owner/repo/pull/123 をレビューして
```

→ `gh pr diff 123` を使用してPRの変更を分析

## レビューの基準

### コメントの優先度

| 優先度 | ラベル | 説明 |
|--------|--------|------|
| 高 | 🔴 要確認 | マージ前に必ず対応が必要 |
| 中 | 🟡 改善提案 | 対応推奨だがブロッカーではない |
| 低 | 🟢 Nit | 些細な指摘、対応は任意 |
| - | 🎉 良い点 | ポジティブフィードバック |

### コメントのトーン

- 建設的で具体的
- 問題と解決策の両方を提示
- 「なぜ」の説明を含める
- 良い点も積極的にコメント

## 注意事項

- 変更の意図を理解してからコメントする
- プロジェクトの既存のスタイル・慣習を尊重
- 些細な指摘で埋め尽くさない
- 自動フォーマッタで対応できるものは指摘しない
