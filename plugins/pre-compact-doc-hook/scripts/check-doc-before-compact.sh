#!/bin/bash

# PreCompact Hook: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ/æ›´æ–°ã®ç¢ºèª
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒcompactingã•ã‚Œã‚‹å‰ã«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ/æ›´æ–°ã‚’ä¿ƒã™

DOC_DIR=".claude/custom-documents"

# å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
CHANGED_FILES=$(git status --porcelain 2>/dev/null | wc -l)

if [ "$CHANGED_FILES" -eq 0 ]; then
    # å¤‰æ›´ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    exit 0
fi

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ -d "$DOC_DIR" ]; then
    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
    DOC_COUNT=$(find "$DOC_DIR" -maxdepth 1 -type d | wc -l)

    if [ "$DOC_COUNT" -gt 1 ]; then
        # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ â†’ update-docã‚’ä¿ƒã™
        echo "ðŸ“ ã€PreCompacté€šçŸ¥ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒcompactingã•ã‚Œã¾ã™ã€‚" >&2
        echo "" >&2
        echo "ç¾åœ¨ $CHANGED_FILES å€‹ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚" >&2
        echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã§ã€compactingå¾Œã‚‚ä½œæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã§ãã¾ã™ã€‚" >&2
        echo "" >&2
        echo "æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: /custom-doc-plugin:update-doc ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
    else
        # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã‚ã‚‹ãŒä¸­èº«ãŒãªã„ â†’ create-docã‚’ä¿ƒã™
        echo "ðŸ“ ã€PreCompacté€šçŸ¥ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒcompactingã•ã‚Œã¾ã™ã€‚" >&2
        echo "" >&2
        echo "ç¾åœ¨ $CHANGED_FILES å€‹ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚" >&2
        echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€compactingå¾Œã‚‚ä½œæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã§ãã¾ã™ã€‚" >&2
        echo "" >&2
        echo "æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: /custom-doc-plugin:create-doc ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
    fi
else
    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„ â†’ create-docã‚’ä¿ƒã™
    echo "ðŸ“ ã€PreCompacté€šçŸ¥ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒcompactingã•ã‚Œã¾ã™ã€‚" >&2
    echo "" >&2
    echo "ç¾åœ¨ $CHANGED_FILES å€‹ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚" >&2
    echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€compactingå¾Œã‚‚ä½œæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã§ãã¾ã™ã€‚" >&2
    echo "" >&2
    echo "æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: /custom-doc-plugin:create-doc ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
fi

exit 0
