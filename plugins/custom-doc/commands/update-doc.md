---
allowed-tools:
  - Read
  - Write
  - Edit
  - Glob
  - Bash
  - Bash(git add:*)
  - Bash(git status:*)
  - Bash(git diff:*)
  - Bash(python3:*)
description: 既存のカスタムドキュメントを更新
argument-hint: <ディレクトリ名>
---

## 実行内容

`.claude/custom-documents` 内の既存ドキュメントに、**まだドキュメントに記載していない変更内容**を追記します。

## 重要な動作ルール

### 1. 未記載の変更のみを対象
- `git status` および `git diff` で検出される全ての変更ファイルを取得
- 既にドキュメントの「変更したファイル」セクションに記載済みのファイルは除外
- 残った「未記載のファイル」の変更内容を追記

**例:**
```
既存ドキュメント内の記載:
- src/auth/login.ts
- src/auth/middleware.ts

現在の変更ファイル (git status):
M  src/auth/login.ts        ← 記載済み（スキップ）
M  src/auth/middleware.ts   ← 記載済み（スキップ）
M  src/auth/logout.ts       ← 未記載（追記対象）
A  src/auth/session.ts      ← 未記載（追記対象）

→ logout.ts と session.ts の変更のみを追記
```

### 2. 関連性チェックと確認
更新対象のドキュメントと変更ファイルの関連性をチェック：

**関連性が高い場合（自動的に更新）:**
```
ドキュメント: feature-auth-login
変更ファイル: src/auth/login.ts, src/auth/middleware.ts
→ ✅ 関連性あり、自動的に更新
```

**関連性が低い場合（確認を求める）:**
```
ドキュメント: feature-auth-login
変更ファイル: src/database/migration.ts, src/api/users.ts
→ ⚠️ 警告を表示:

「警告: 更新対象のドキュメント 'feature-auth-login' と
変更されたファイルの関連性が低い可能性があります。

変更ファイル:
- src/database/migration.ts
- src/api/users.ts

このドキュメントを更新しますか？
(y) はい、更新する
(n) いいえ、別のドキュメントを選択
(c) キャンセル
```

### 3. 関連性判定ロジック
以下のいずれかに該当する場合、関連性が高いと判断：

- ドキュメント名に含まれるキーワードが変更ファイルパスに含まれる
  - 例: `feature-auth-*` ↔ `src/auth/`, `auth.ts`
- 変更ファイルのディレクトリ名がドキュメント名と一致
  - 例: `api-users` ↔ `src/api/users/`
- ドキュメント内の「変更したファイル」セクションに既に記載されているファイルと同じディレクトリ
  - 例: ドキュメントに `src/auth/login.ts` が記載済み → `src/auth/logout.ts` は関連性あり

## 使用方法

```bash
/update-doc              # 引数なし：候補を表示して選択
/update-doc auth         # キーワード絞り込み："auth"を含むドキュメントを検索
/update-doc feature-auth # 完全一致：直接指定
```

## 絞り込み動作

### パターン1: 引数なし
```bash
/update-doc
```
1. `.claude/custom-documents/` 内の全ドキュメントをリスト表示
   ```
   以下のドキュメントが見つかりました：
   1. feature-auth-login
   2. feature-auth-signup
   3. api-auth-system
   4. refactor-database

   番号を入力してください、またはキーワードで絞り込めます
   ```
2. 番号で選択 or キーワード入力で絞り込み
3. ユーザーの応答を待つ（会話的な選択）

### パターン2: キーワード指定
```bash
/update-doc auth
```
1. "auth"を含むドキュメントを検索（部分一致）
2. **1件のみヒット** → 自動選択して確認
3. **複数ヒット** → リスト表示して会話的に選択
4. **ヒットなし** → 全ドキュメントを表示

### パターン3: 完全一致
```bash
/update-doc feature-auth-system
```
1. 完全一致するディレクトリがあれば自動選択
2. なければパターン2の部分一致で検索

## 選択方式

**ヘルパースクリプトを使用:**
- `scripts/select-doc.py` を使ってインタラクティブに選択
- 候補が複数ある場合、番号付きリストで表示
- ユーザーの応答を待って、番号またはキーワードを受け付ける
- 候補数に制限なし（大量のドキュメントにも対応）

### スクリプトの使い方
```bash
# 全ドキュメントから選択
python3 .claude-plugin/scripts/select-doc.py

# キーワードで絞り込んでから選択
python3 .claude-plugin/scripts/select-doc.py auth

# コマンド内での利用例
SELECTED=$(python3 .claude-plugin/scripts/select-doc.py "$ARGUMENT")
echo "選択: $SELECTED"
```

選択されたディレクトリ名が標準出力に出力されるので、それを使ってドキュメントを更新します。

## 自動的に追加される内容

### 1. 変更したファイル
`git status` と `git diff` から変更ファイルを検出し、追記します。

### 2. 実装内容
このセッションでの会話と変更内容から、実装した内容を抽出して追加します。

### 3. 技術的な背景・解説
必要に応じて、新しい技術トピックを追加します。

### 4. 関連知識・参考資料
参照した公式ドキュメントや記事があれば追加します。

## 動作フロー

1. **変更ファイルの検出**
   - `git status` で現在の変更ファイル一覧を取得
   - Staged/Unstaged/Untracked すべてを対象とする

2. **対象ドキュメントの選択**
   - 指定されたディレクトリを `.claude/custom-documents/` 内で検索
   - ヘルパースクリプトで絞り込み・選択

3. **既存ドキュメントの解析**
   - 既存ドキュメントを読み込み
   - 「変更したファイル」セクションから記載済みファイルのリストを抽出
   - 例: `- src/auth/login.ts` → `src/auth/login.ts` を抽出

4. **未記載ファイルの特定**
   - 現在の変更ファイル - 記載済みファイル = 追記対象ファイル
   - 追記対象ファイルが0件の場合 → 「すべて記載済みです」と表示して終了

5. **関連性チェック**
   - 追記対象ファイルとドキュメントの関連性を判定
   - 関連性が低い場合は警告を表示し、確認を求める

6. **変更内容の抽出**
   - 追記対象ファイルの `git diff` を解析
   - 会話履歴から実装内容を抽出
   - 技術的な背景や参考資料を収集

7. **ドキュメント更新**
   - 各セクションに新しい情報を追記（タイムスタンプ付き）
   - 既存内容との重複は自動的にスキップ

8. **確認と保存**
   - 追加される内容のプレビューを表示
   - ユーザーに確認を求める
   - 承認後にドキュメントを保存

## 更新例

**Before:**
```markdown
## 変更したファイル
- `src/auth/login.ts` - ログイン機能の実装

## 実装内容
### ログイン機能
- JWT認証の実装
```

**After:**
```markdown
## 変更したファイル
- `src/auth/login.ts` - ログイン機能の実装
- `src/auth/logout.ts` - ログアウト機能の追加（2024-11-22）

## 実装内容
### ログイン機能
- JWT認証の実装

### ログアウト機能（2024-11-22追加）
- トークン無効化の実装
- セッション削除処理
```

## 注意点

- **ドキュメントに未記載の変更のみ**が対象となります
  - 既にドキュメントに記載済みのファイルは自動的にスキップされます
  - 何度でも `/update-doc` を実行できます（差分のみ追記）
- 既存内容は保持され、新しい内容が追記されます
- タイムスタンプ `(YYYY-MM-DD追加)` が自動的に付きます
- 重複内容は自動的にスキップされます
- **関連性が低いファイル変更の場合は確認が求められます**
  - 確実に正しいドキュメントを選択していることを確認してください
  - 間違ったドキュメントに追記すると内容が混乱します
- **コミットのタイミングは任意**
  - ドキュメント更新後にまとめてコミットしても構いません
  - 作業途中で何度でも `/update-doc` できます
